{% extends "base.html" %}

{% block head %}
<header>
    <h1>
        <a href="/">TRIPTROVE</a>
    </h1>
    <nav>
        <a href="/trip/{{trip_id}}">Back to Trip</a>
    </nav>
</header>
{% endblock %}

{% block body %}
<div class="album-container">
    <h2 class="album-title">{{trip.trip_location}} Photo Album</h2>
    
    <div class="album-grid">
        <!-- Upload Box (First Position) -->
        <div class="album-item upload-box" onclick="document.getElementById('photo-upload').click()">
            <div class="upload-icon">+</div>
            <div class="upload-text">Add New Photo</div>
            <form id="upload-form" action="/album/{{trip_id}}/upload" method="POST" enctype="multipart/form-data" style="display: none;">
                <input type="file" id="photo-upload" name="photo" accept="image/*" onchange="document.getElementById('upload-form').submit()">
            </form>
        </div>
        
        <!-- Display Photos -->
        {% for photo in photos %}
        <div class="album-item" data-photo-id="{{ photo.photo_id }}">
            <img src="{{ url_for('static', filename=photo.photo_path) }}" alt="{{photo.photo_alt}}">
            
            <!-- Photo Menu (appears on hover) -->
            <span class="photo-menu" data-photo-id="{{ photo.photo_id }}">≡</span>
            
            <div class="album-caption">
                <h3>{{trip.trip_location}}</h3>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Popup menu (outside grid, positioned absolutely) -->
<div class="popup-menu photo-popup" id="photo-popup" style="display: none;">
    <h1>MANAGE PHOTO</h1>
    <a href="#" class="popup-option replace-option" id="replace-link"> → Replace</a>
    <a href="#" class="popup-option delete-option" id="delete-link"> → Delete</a>
</div>

<script>
// Toggle photo menu popup
document.addEventListener('DOMContentLoaded', function() {
    const photoMenus = document.querySelectorAll('.photo-menu');
    const popup = document.getElementById('photo-popup');
    const replaceLink = document.getElementById('replace-link');
    const deleteLink = document.getElementById('delete-link');
    let currentPhotoId = null;
    
    photoMenus.forEach(function(menu) {
        menu.addEventListener('click', function(e) {
            e.stopPropagation();
            e.preventDefault();
            
            const photoId = this.getAttribute('data-photo-id');
            currentPhotoId = photoId;
            
            // Position popup near the clicked menu
            const rect = this.getBoundingClientRect();
            popup.style.position = 'fixed';
            popup.style.top = (rect.bottom + 5) + 'px';
            popup.style.left = (rect.left - 100) + 'px';
            popup.style.display = 'flex';
            
            // Update links
            replaceLink.href = '/album/update/' + photoId;
            deleteLink.href = '/album/delete/' + photoId;
            deleteLink.onclick = function() {
                return confirm('Are you sure you want to delete this photo?');
            };
        });
    });

    // Close popup when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.photo-menu') && !e.target.closest('.photo-popup')) {
            popup.style.display = 'none';
        }
    });
    
    // Prevent popup from closing when clicking inside it
    popup.addEventListener('click', function(e) {
        e.stopPropagation();
    });
});
</script>

{% endblock %}

{% block footer %}
<p>TRIPTROVE 2025</p>
{% endblock %}