{% extends "base.html" %}

{% block head %}
<header>
    <h1>
        <a href="/">TRIPTROVE</a>
    </h1>
    <nav>
        <a href="/journal/add/{{ trip_id }}" class="new-entry-btn">New Entry</a>
        <a href="#" class="sort-btn">Sort ⇅</a>
        <!-- Sort popup menu -->
        <div class="popup-menu sort-popup" id="sort-popup">
            <h1>SORT ENTRIES BY</h1>
            <a href="/journal/{{ trip_id }}?sort=date_asc" class="popup-option">→ Date (Oldest First)</a>
            <a href="/journal/{{ trip_id }}?sort=date_desc" class="popup-option">→ Date (Newest First)</a>
            <a href="/journal/{{ trip_id }}?sort=id_asc" class="popup-option">→ Least Recently Added</a>
            <a href="/journal/{{ trip_id }}?sort=id_desc" class="popup-option">→ Most Recently Added</a>
        </div>
    </nav>
</header>
{% endblock %}

{% block body %}
<div class="journal-full-container">
    <h2 class="journal-title">Journal</h2>
    
    {% if entries %}
    <div class="journal-entries-full">
        {% for entry in entries %}
        <div class="journal-entry" data-entry-id="{{ entry[2] }}">
            <div class="entry-header">
                <!-- View mode date -->
                <h3 class="entry-date view-mode">{{ entry[0] }}</h3>
                <!-- Edit mode date -->
                <input type="date" class="entry-date-input edit-mode" value="{{ entry[0] }}" style="display: none;">
                
                <div style="position: relative;">
                    <span class="entry-menu" data-entry-id="{{ entry[2] }}">•••</span>
                    <div class="popup-menu entry-popup" id="entry-popup-{{ entry[2] }}">
                        <h1>MANAGE ENTRY</h1>
                        <a href="#" class="popup-option edit-option" data-entry-id="{{ entry[2] }}"> → Edit</a>
                        <a href="/journal/delete/{{ entry[2] }}" class="popup-option delete-option" onclick="return confirm('Are you sure you want to delete this entry?')"> → Delete</a>
                    </div>
                </div>
            </div>
            
            <!-- View mode text -->
            <p class="entry-text view-mode">{{ entry[1] }}</p>
            
            <!-- Edit mode text -->
            <textarea class="entry-text-input edit-mode" style="display: none;">{{ entry[1] }}</textarea>
            
            <!-- Edit mode buttons -->
            <div class="edit-buttons edit-mode" style="display: none;">
                <button class="save-btn" data-entry-id="{{ entry[2] }}">Save</button>
                <button class="cancel-edit-btn">Cancel</button>
            </div>
        </div>
        {% if not loop.last %}
        <hr class="entry-divider">
        {% endif %}
        {% endfor %}
    </div>
    {% else %}
    <p class="no-entries">No journal entries yet. Click "New Entry" to add one!</p>
    {% endif %}
</div>



<script>
// Combined popup menu and inline editing handling
document.addEventListener('DOMContentLoaded', function() {
    // Sort button functionality
    const sortBtn = document.querySelector('.sort-btn');
    const sortPopup = document.getElementById('sort-popup');
    
    if (sortBtn && sortPopup) {
        sortBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            // Close all entry popups
            document.querySelectorAll('.entry-popup').forEach(function(popup) {
                popup.classList.remove('show');
            });
            
            // Toggle sort popup
            sortPopup.classList.toggle('show');
        });
    }
    
    // Entry menu functionality
    const entryMenus = document.querySelectorAll('.entry-menu');
    
    entryMenus.forEach(function(menu) {
        menu.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const entryId = this.getAttribute('data-entry-id');
            const popup = document.getElementById('entry-popup-' + entryId);
            
            if (popup) {
                // Close sort popup
                if (sortPopup) {
                    sortPopup.classList.remove('show');
                }
                
                // Close all other entry popups
                document.querySelectorAll('.entry-popup').forEach(function(p) {
                    if (p.id !== 'entry-popup-' + entryId) {
                        p.classList.remove('show');
                    }
                });
                
                // Toggle current popup
                popup.classList.toggle('show');
            }
        });
    });

    // Close all popups when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.entry-menu') && 
            !e.target.closest('.sort-btn') && 
            !e.target.closest('.popup-menu')) {
            document.querySelectorAll('.popup-menu').forEach(function(popup) {
                popup.classList.remove('show');
            });
        }
    });
    
    // INLINE EDITING FUNCTIONALITY
    
    // Edit button click
    document.querySelectorAll('.edit-option').forEach(function(editBtn) {
        editBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const entryId = this.getAttribute('data-entry-id');
            const entryDiv = document.querySelector('.journal-entry[data-entry-id="' + entryId + '"]');
            
            // Hide view mode, show edit mode
            entryDiv.querySelectorAll('.view-mode').forEach(el => el.style.display = 'none');
            entryDiv.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'block');
            
            // Close popup
            document.getElementById('entry-popup-' + entryId).classList.remove('show');
        });
    });
    
    // Cancel button click
    document.querySelectorAll('.cancel-edit-btn').forEach(function(cancelBtn) {
        cancelBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const entryDiv = this.closest('.journal-entry');
            
            // Reset textarea to original value
            const originalText = entryDiv.querySelector('.entry-text').textContent;
            const originalDate = entryDiv.querySelector('.entry-date').textContent;
            entryDiv.querySelector('.entry-text-input').value = originalText;
            entryDiv.querySelector('.entry-date-input').value = originalDate;
            
            // Show view mode, hide edit mode
            entryDiv.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
            entryDiv.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
        });
    });
    
    // Save button click
    document.querySelectorAll('.save-btn').forEach(function(saveBtn) {
        saveBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const entryId = this.getAttribute('data-entry-id');
            const entryDiv = this.closest('.journal-entry');
            const newDate = entryDiv.querySelector('.entry-date-input').value;
            const newText = entryDiv.querySelector('.entry-text-input').value;
            
            // Send AJAX request to update
            fetch('/journal/update/' + entryId, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: 'entry_date=' + encodeURIComponent(newDate) + 
                      '&journal_entry=' + encodeURIComponent(newText)
            })
            .then(response => {
                if (response.ok) {
                    // Update the display
                    entryDiv.querySelector('.entry-date').textContent = newDate;
                    entryDiv.querySelector('.entry-text').textContent = newText;
                    
                    // Show view mode, hide edit mode
                    entryDiv.querySelectorAll('.view-mode').forEach(el => el.style.display = 'block');
                    entryDiv.querySelectorAll('.edit-mode').forEach(el => el.style.display = 'none');
                } else {
                    alert('Error updating entry. Please try again.');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error updating entry. Please try again.');
            });
        });
    });
});
</script>
{% endblock %}

{% block footer %}
<p>TRIPTROVE 2025</p>
{% endblock %}